<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Surge IPA Installer (çº¯å‰ç«¯)</title>
<style>
:root{--bg:#f5f5f7;--card:#fff;--accent:#007aff;--muted:#666}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;background:var(--bg);color:#111}
.wrap{padding:14px;padding-bottom:90px}
.card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
input,select,button,textarea{width:100%;box-sizing:border-box;font-size:15px;padding:10px;border-radius:8px;border:1px solid #ddd}
button{background:var(--accent);color:#fff;border:none}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:62px;display:flex;background:#fff;border-top:1px solid #e6e6e6}
.tabbar button{flex:1;border:0;background:transparent;font-size:13px;padding:8px}
.hidden{display:none}
.title{font-weight:600;margin-bottom:8px}
.row{display:flex;gap:8px}
.half{flex:1}
.result{white-space:pre-wrap;font-size:13px;color:var(--muted);margin-top:8px}
.app-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;border:1px solid #eee;margin-bottom:8px;background:#fff}
.app-item img{width:56px;height:56px;border-radius:12px;object-fit:cover}
.app-info{flex:1}
.small{font-size:13px;color:#666}
.btn-row{display:flex;gap:8px;margin-top:8px}
.tiny{padding:8px 10px;font-size:13px;border-radius:8px}
.danger{background:#ff3b30}
.ok{background:#34c759}
.progress{height:8px;background:#eee;border-radius:6px;margin-top:8px;overflow:hidden}
.progress > i{display:block;height:100%;background:var(--accent);width:0}
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN PAGE (for adding new account) -->
  <div id="page-login" class="page hidden">
    <div class="card">
      <div class="title">Apple è´¦å·ç™»å½•ï¼ˆæ”¯æŒ 2FAï¼‰</div>
      <input id="loginEmail" placeholder="Apple IDï¼ˆé‚®ç®±ï¼‰" />
      <input id="loginPassword" placeholder="å¯†ç " type="password" style="margin-top:8px" />
      <div style="height:8px"></div>
      <button onclick="doLogin()">ç™»å½•</button>
      <div id="loginMsg" class="result"></div>
    </div>

    <div id="twofaBox" class="card hidden">
      <div class="title">è¾“å…¥è®¾å¤‡å‘é€çš„ 6 ä½éªŒè¯ç </div>
      <input id="twofaCode" placeholder="6 ä½éªŒè¯ç " />
      <div style="height:8px"></div>
      <div class="row">
        <button class="half" onclick="submit2FA()">æäº¤éªŒè¯ç </button>
        <button class="half tiny danger" onclick="cancel2FA()">å–æ¶ˆ</button>
      </div>
      <div id="twofaMsg" class="result"></div>
    </div>
  </div>

  <!-- SEARCH PAGE -->
  <div id="page-search" class="page">
    <div class="card">
      <div class="title">æœç´¢åº”ç”¨</div>
      <input id="searchInput" placeholder="è¾“å…¥åº”ç”¨åç§°æˆ– Bundle IDï¼ˆä¾‹å¦‚ WeChat / com.tencent.xinï¼‰" />
      <div style="height:8px"></div>

      <div class="row">
        <select id="regionSelect" class="half">
          <option value="CN">ä¸­å›½ (CN)</option>
          <option value="US">ç¾å›½ (US)</option>
          <option value="JP">æ—¥æœ¬ (JP)</option>
          <option value="HK">é¦™æ¸¯ (HK)</option>
          <option value="TW">å°æ¹¾ (TW)</option>
          <option value="GB">è‹±å›½ (GB)</option>
          <option value="DE">å¾·å›½ (DE)</option>
        </select>

        <select id="limitSelect" class="half">
          <option value="5">5 æ¡</option>
          <option value="10" selected>10 æ¡</option>
          <option value="20">20 æ¡</option>
        </select>
      </div>

      <div style="height:8px"></div>
      <select id="deviceSelect">
        <option value="iphone">iPhone</option>
        <option value="ipad">iPad</option>
        <option value="both" selected>iPhone + iPad</option>
      </select>

      <div style="height:12px"></div>
      <div class="row">
        <button class="half" onclick="doSearch()">å¼€å§‹æœç´¢</button>
        <button class="half tiny" onclick="navTo('login')">è´¦å·ç™»å½•</button>
      </div>

      <div id="searchMsg" class="result"></div>
    </div>

    <div id="searchResults"></div>
  </div>

  <!-- APP DETAIL modal-ish (hidden block) -->
  <div id="appDetailBox" class="card hidden"></div>

  <!-- TASKS PAGE -->
  <div id="page-tasks" class="page hidden">
    <div class="card">
      <div class="title">ä¸‹è½½ä»»åŠ¡</div>
      <div class="small">è¯´æ˜ï¼šåç«¯è¿”å› IPA ç›´é“¾ï¼›å‰ç«¯å°†æŠŠé“¾æ¥ä¿å­˜ä¸ºä»»åŠ¡å¹¶æ£€æµ‹å¯è¾¾æ€§ï¼Œå®Œæˆåå¯ç›´æ¥å®‰è£…ã€‚</div>
    </div>
    <div id="taskList"></div>
  </div>

  <!-- ACCOUNTS PAGE -->
  <div id="page-accounts" class="page hidden">
    <div class="card">
      <div class="title">å¤šè´¦å·ï¼ˆæœ¬åœ°ä¿å­˜ç™»å½•å“åº”ï¼‰</div>
      <div class="small">ç™»å½•æˆåŠŸåè´¦å·ä¼šä¿å­˜åˆ°æœ¬åœ°ã€‚åˆ‡æ¢è´¦å·å°†è¯·æ±‚åç«¯åˆ·æ–°ä¼šè¯ï¼ˆ/auth/refreshï¼‰ï¼Œè‹¥åç«¯ç¼“å­˜äº†è¯¥è´¦å·ä¼šç”Ÿæ•ˆã€‚</div>
    </div>
    <div id="accountsList"></div>
  </div>

</div>

<div class="tabbar">
  <button onclick="navTo('search')">ğŸ” æœç´¢</button>
  <button onclick="navTo('tasks')">â¬‡ï¸ ä»»åŠ¡</button>
  <button onclick="navTo('accounts')">ğŸ‘¤ è´¦å·</button>
  <button onclick="navTo('login')">ï¼‹ ç™»å½•</button>
</div>

<script>
/*
  Surge å‰ç«¯ H5ï¼š
  - ä½¿ç”¨åç«¯è·¯ç”±ï¼ˆæ¥è‡ªä½ æä¾›çš„ AppleStoreAPI.jsï¼‰ï¼š
    POST /auth/login ï¼ˆbody: { appleId, password, code? }ï¼‰
    POST /auth/refresh ï¼ˆæ— å‚ï¼‰
    GET  /apps/search/:term?limit=&country=
    GET  /apps/:id?appVerId=  -> è¿”å› appInfoï¼ˆå« url å­—æ®µï¼‰
    GET  /apps/:id/versions?direction=&count=&appVerId=
    GET  /apps/:id/versions/legacy?selset=
  - å®‰è£… manifest ä½¿ç”¨ï¼šhttps://xiaobai.app/?name=...&displayVersion=...&id=...&bundleId=...
    ç„¶åè·³è½¬ itms-services://?action=download-manifest&url=MANIFEST_URL
*/

// é»˜è®¤åç«¯åŸŸåï¼ˆå›ºå®šåœ¨ Surge å†…è¿è¡Œï¼‰
const API = 'https://apple-api.com';
const INSTALL_HOST = 'https://xiaobai.app';

// ---------- navigation ----------
function navTo(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById('page-'+page).classList.remove('hidden');
  document.getElementById('loginMsg').innerText=''; document.getElementById('searchMsg').innerText='';
  if(page==='tasks') renderTasks();
  if(page==='accounts') renderAccounts();
}

// ---------- accounts storage ----------
function loadAccounts(){ return JSON.parse(localStorage.getItem('apple_accounts') || '{"current":null,"list":{}}'); }
function saveAccounts(o){ localStorage.setItem('apple_accounts', JSON.stringify(o)); }

// render accounts UI
function renderAccounts(){
  const box = document.getElementById('accountsList'); box.innerHTML='';
  const acc = loadAccounts();
  const keys = Object.keys(acc.list || {});
  if(!keys.length){ box.innerHTML = '<div class="card small">æš‚æ— å·²ä¿å­˜è´¦å·</div>'; return; }
  keys.forEach(k=>{
    const info = acc.list[k];
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${k}</strong><div class="small">${info.appleId || ''}</div></div>
      <div>
        <button class="tiny" onclick="switchAccount('${k}')">åˆ‡æ¢</button>
        <button class="tiny danger" onclick="removeAccount('${k}')">åˆ é™¤</button>
      </div>
    </div>`;
    box.appendChild(div);
  });
}

function switchAccount(k){
  const acc = loadAccounts();
  if(!acc.list[k]) return alert('è´¦å·ä¸å­˜åœ¨');
  acc.current = k; saveAccounts(acc);
  // è¯·æ±‚åç«¯åˆ·æ–°ä¼šè¯ï¼ˆåç«¯ AuthService.login ä¼šä»ç¼“å­˜ä¸­è¯»å–ï¼‰
  fetch(API + '/auth/refresh', {method:'POST'}).then(r=>r.json()).then(j=>{
    alert('å·²è¯·æ±‚åç«¯åˆ·æ–°ç™»å½•ï¼ˆè‹¥åç«¯ç¼“å­˜å­˜åœ¨åˆ™ä¼šåˆ‡æ¢ï¼‰ã€‚\nåç«¯è¿”å›ï¼š' + JSON.stringify(j));
  }).catch(e=>alert('åˆ·æ–°å¤±è´¥ï¼š'+e.message));
  renderAccounts();
}

function removeAccount(k){
  if(!confirm('åˆ é™¤è´¦å· ' + k + ' ?')) return;
  const acc = loadAccounts();
  delete acc.list[k]; if(acc.current===k) acc.current=null; saveAccounts(acc); renderAccounts();
}

// ---------- LOGIN (supports optional code param for 2FA) ----------
let pendingLogin = null; // store {name,email,password}
async function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const pwd = document.getElementById('loginPassword').value.trim();
  if(!email || !pwd) { document.getElementById('loginMsg').innerText = 'è¯·è¾“å…¥ Apple ID ä¸å¯†ç '; return; }
  document.getElementById('loginMsg').innerText = 'æ­£åœ¨ç™»å½•...';
  try{
    const resp = await fetch(API + '/auth/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ appleId: email, password: pwd })
    });
    const j = await resp.json();
    // åç«¯è®¾è®¡ï¼šå¦‚æœéœ€è¦2FAå¯åœ¨è¿”å›ä¸­ä½“ç°ï¼ˆæˆ‘ä»¬é€šè¿‡æ£€æµ‹ accountInfo æ¥åˆ¤å®šæ˜¯å¦ç™»å½•ï¼‰
    if(j && j.success===false){ document.getElementById('loginMsg').innerText = 'ç™»å½•å¤±è´¥ï¼š'+JSON.stringify(j.error || j); return; }
    const payload = j.data || j;
    // if payload contains accountInfo -> logged in
    if(payload && payload.loginData?.accountInfo || payload.accountInfo){
      // success
      const acc = loadAccounts();
      const key = email; // use email as key (no nickname)
      acc.list[key] = { appleId: email, meta: payload.loginData || payload };
      acc.current = key; saveAccounts(acc);
      document.getElementById('loginMsg').innerText = 'ç™»å½•æˆåŠŸå¹¶å·²ä¿å­˜æœ¬åœ°ã€‚';
      document.getElementById('loginEmail').value=''; document.getElementById('loginPassword').value='';
      renderAccounts();
      return;
    }
    // if not logged and server indicates need for 2FA (server-specific)
    // We'll assume server returns something indicating 2FA is required; since server uses same endpoint with code support,
    // set pendingLogin and show 2FA box.
    pendingLogin = { appleId: email, password: pwd };
    document.getElementById('loginMsg').innerText = 'éœ€è¦è®¾å¤‡éªŒè¯ç ï¼ˆè¯·æŸ¥çœ‹ iPhone/iPad å¼¹çª—ï¼‰ï¼Œè¾“å…¥åæäº¤ã€‚';
    document.getElementById('twofaBox').classList.remove('hidden');
  }catch(e){
    document.getElementById('loginMsg').innerText = 'ç™»å½•è¯·æ±‚å¤±è´¥ï¼š' + e.message;
  }
}

async function submit2FA(){
  const code = document.getElementById('twofaCode').value.trim();
  if(!pendingLogin) return alert('æ— å¾…éªŒè¯ç™»å½•ï¼Œè¯·å…ˆè¾“å…¥è´¦å·å¯†ç å¹¶æäº¤ç™»å½•ã€‚');
  if(!/^\d{4,6}$/.test(code)) return alert('è¯·è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç ï¼ˆ4-6 ä½æ•°å­—ï¼‰');
  document.getElementById('twofaMsg').innerText = 'æäº¤ä¸­...';
  try{
    const body = { appleId: pendingLogin.appleId, password: pendingLogin.password, code };
    const resp = await fetch(API + '/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const j = await resp.json();
    if(j && j.success===false){ document.getElementById('twofaMsg').innerText = 'éªŒè¯å¤±è´¥ï¼š'+JSON.stringify(j.error||j); return; }
    const payload = j.data || j;
    if(payload && (payload.loginData?.accountInfo || payload.accountInfo)){
      const acc = loadAccounts(); const key = pendingLogin.appleId;
      acc.list[key] = { appleId: pendingLogin.appleId, meta: payload.loginData || payload };
      acc.current = key; saveAccounts(acc);
      document.getElementById('twofaMsg').innerText = 'ç™»å½•å¹¶ä¿å­˜æˆåŠŸ';
      pendingLogin = null; document.getElementById('twofaBox').classList.add('hidden'); renderAccounts();
      return;
    }
    document.getElementById('twofaMsg').innerText = 'æœªçŸ¥å“åº”ï¼š' + JSON.stringify(j);
  }catch(e){
    document.getElementById('twofaMsg').innerText = 'æäº¤éªŒè¯ç å¤±è´¥ï¼š' + e.message;
  }
}
function cancel2FA(){ pendingLogin = null; document.getElementById('twofaBox').classList.add('hidden'); }

// ---------- SEARCH ----------
async function doSearch(){
  const q = document.getElementById('searchInput').value.trim();
  if(!q){ document.getElementById('searchMsg').innerText = 'è¯·è¾“å…¥æœç´¢å…³é”®è¯æˆ– Bundle ID'; return; }
  const region = document.getElementById('regionSelect').value;
  const limit = document.getElementById('limitSelect').value;
  document.getElementById('searchMsg').innerText = 'æ­£åœ¨æœç´¢...';
  try{
    const url = API + '/apps/search/' + encodeURIComponent(q) + `?limit=${limit}&country=${encodeURIComponent(region)}`;
    const r = await fetch(url); const j = await r.json();
    const list = (j && j.data) ? j.data : (j || []);
    renderSearchResults(list);
    document.getElementById('searchMsg').innerText = 'æœç´¢å®Œæˆ';
  }catch(e){
    document.getElementById('searchMsg').innerText = 'æœç´¢å¤±è´¥ï¼š' + e.message;
  }
}

function renderSearchResults(list){
  const wrap = document.getElementById('searchResults'); wrap.innerHTML='';
  if(!list || !list.length){ wrap.innerHTML='<div class="card small">æœªæ‰¾åˆ°ç»“æœ</div>'; return; }
  list.forEach(app=>{
    const div = document.createElement('div'); div.className='card app-item';
    const icon = document.createElement('img'); icon.src = app.artworkUrl100 || app.icon || '';
    const info = document.createElement('div'); info.className='app-info';
    const name = document.createElement('div'); name.innerHTML = `<strong>${app.trackName || app.name || app.title || app.bundleId}</strong>`;
    const sub = document.createElement('div'); sub.className='small'; sub.innerText = `Bundleï¼š${app.bundleId||app.bundleId||''}  ç‰ˆæœ¬ï¼š${app.version||app.displayVersion||''}`;
    const row = document.createElement('div'); row.className='btn-row';
    const detailBtn = document.createElement('button'); detailBtn.className='tiny'; detailBtn.innerText='è¯¦æƒ…/ç‰ˆæœ¬'; detailBtn.onclick = ()=>showAppDetail(app);
    const dlBtn = document.createElement('button'); dlBtn.className='tiny ok'; dlBtn.innerText='è·å– IPA'; dlBtn.onclick = ()=>createDownloadTask(app);
    row.appendChild(detailBtn); row.appendChild(dlBtn);
    info.appendChild(name); info.appendChild(sub); info.appendChild(row);
    div.appendChild(icon); div.appendChild(info);
    wrap.appendChild(div);
  });
}

// show app detail (and versions)
async function showAppDetail(app){
  const container = document.getElementById('appDetailBox'); container.classList.remove('hidden'); container.innerHTML = '<div class="title">åŠ è½½ä¸­...</div>';
  const id = app.trackId || app.collectionId || app.trackId;
  try{
    const verUrl = API + '/apps/' + encodeURIComponent(id) + '/versions';
    const r = await fetch(verUrl); const j = await r.json();
    const versions = j && j.data ? j.data : [];
    // render
    let html = `<div style="display:flex;gap:12px"><img style="width:84px;height:84px;border-radius:12px" src="${app.artworkUrl100||app.icon||''}" /><div><div style="font-weight:600">${app.trackName||app.name||''}</div><div class="small">Bundle: ${app.bundleId||''}</div></div></div>`;
    html += '<div style="height:10px"></div><div class="title">å¯ç”¨ç‰ˆæœ¬</div>';
    if(!versions.length) html += '<div class="small">æœªè¿”å›ç‰ˆæœ¬åˆ—è¡¨ï¼Œå¯å°è¯•ç›´æ¥ç‚¹å‡» è·å– IPA</div>';
    else{
      html += '<div class="small">ç‚¹å‡»ç‰ˆæœ¬å°†ä½¿ç”¨è¯¥å¤–éƒ¨ç‰ˆæœ¬ ID è·å– IPA</div>';
      versions.forEach(v=>{
        // v may be [external_identifier, bundle_version]
        const extId = Array.isArray(v) ? v[0] : v.externalVersionId || v[0];
        const disp = Array.isArray(v) ? v[1] : v.displayVersion || v[1] || v[0];
        html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px"><div>${disp} (${extId})</div><div><button class="tiny" onclick="getIpaByVersion('${encodeURIComponent(id)}','${encodeURIComponent(extId)}','${encodeURIComponent(app.trackName||app.name||'app')}','${encodeURIComponent(disp)}','${encodeURIComponent(app.bundleId||'')}')">ä¸‹è½½è¯¥ç‰ˆæœ¬ IPA</button></div></div>`;
      });
    }
    html += '<div style="height:10px"></div><div><button onclick="document.getElementById(\'appDetailBox\').classList.add(\'hidden\')">å…³é—­</button></div>';
    container.innerHTML = html;
  }catch(e){
    container.innerText = 'ç‰ˆæœ¬æŸ¥è¯¢å¤±è´¥ï¼š' + e.message;
  }
}

// ---------- get IPA by app id (latest if no appVerId) ----------
async function createDownloadTask(app){
  // use app.trackId as id
  const id = app.trackId || app.collectionId || app.trackId;
  await fetchIpaAndCreateTask(id, undefined, app.trackName || app.name || app.bundleId || 'app', app.displayVersion || app.version || '');
}
async function getIpaByVersion(id, appVerId, name, displayVersion, bundleId){
  id = decodeURIComponent(id); appVerId = decodeURIComponent(appVerId);
  await fetchIpaAndCreateTask(id, appVerId, decodeURIComponent(name), decodeURIComponent(displayVersion), decodeURIComponent(bundleId));
}

async function fetchIpaAndCreateTask(id, appVerId, name, displayVersion, bundleId){
  try{
    const q = API + '/apps/' + encodeURIComponent(id) + (appVerId ? ('?appVerId=' + encodeURIComponent(appVerId)) : '');
    const r = await fetch(q); const j = await r.json();
    if(!j || j.success===false) throw new Error(JSON.stringify(j.error || j));
    const info = j.data?.appInfo || j.data || j;
    // attempt to find ipa url
    const ipaUrl = (info && info.appInfo && info.appInfo.appInfo && info.appInfo.appInfo.url) ||
                   (info && info.url) ||
                   (info && info.appInfo && info.appInfo.url) ||
                   info.url || info.appId || info.appInfo?.url;
    // fallback: info.url or info.appInfo.url; server formats vary; try multiple places
    let finalIpa = ipaUrl;
    if(!finalIpa && info && typeof info === 'object'){
      // try common properties
      finalIpa = info.url || info.appInfo?.url || info.songList?.[0]?.URL || null;
    }
    if(!finalIpa) throw new Error('æœªåœ¨åç«¯å“åº”ä¸­æ‰¾åˆ° IPA é“¾æ¥ï¼ˆè¯·ç¡®è®¤è°ƒç”¨ /apps/:id è¿”å›å†…å®¹ç»“æ„ï¼‰');
    // create task
    const tasks = JSON.parse(localStorage.getItem('downloadTasks') || '[]');
    const tid = 't_' + Date.now();
    tasks.unshift({ id: tid, name: name || ('app_' + id), bundleId: bundleId||'', displayVersion: displayVersion||'', appId: id, ipaUrl: finalIpa, status:'ready', createdAt: Date.now() });
    localStorage.setItem('downloadTasks', JSON.stringify(tasks));
    alert('å·²åˆ›å»ºä»»åŠ¡ï¼šå¯åœ¨â€œä»»åŠ¡â€é¡µæŸ¥çœ‹å¹¶å®‰è£…ã€‚');
    renderTasks();
  }catch(e){
    alert('è·å– IPA å¤±è´¥ï¼š' + e.message);
  }
}

// ---------- TASKS UI ----------
function renderTasks(){
  const wrap = document.getElementById('taskList'); wrap.innerHTML='';
  const tasks = JSON.parse(localStorage.getItem('downloadTasks') || '[]');
  if(!tasks.length){ wrap.innerHTML = '<div class="card small">å½“å‰æ²¡æœ‰ä»»åŠ¡</div>'; return; }
  tasks.forEach(t=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${t.name}</strong><div class="small">Bundle:${t.bundleId||'-'}  ç‰ˆæœ¬:${t.displayVersion||'-'}</div></div>
      <div>
        <button class="tiny" onclick="openUrl('${encodeURIComponent(t.ipaUrl)}')">æ‰“å¼€ IPA</button>
        <button class="tiny ok" onclick="installTask('${t.id}')">å®‰è£…</button>
        <button class="tiny danger" onclick="removeTask('${t.id}')">åˆ é™¤</button>
      </div>
    </div>
    <div id="taskstat_${t.id}" class="small" style="margin-top:8px">çŠ¶æ€ï¼š${t.status} Â· åˆ›å»ºäºï¼š${new Date(t.createdAt).toLocaleString()}</div>
    <div class="progress"><i id="prog_${t.id}" style="width:${t.status==='ready'? '100%': '0%'}"></i></div>`;
    wrap.appendChild(d);
  });
}

// open IPA url
function openUrl(enc){ window.open(decodeURIComponent(enc), '_blank'); }

function removeTask(id){ let t = JSON.parse(localStorage.getItem('downloadTasks')||'[]'); t = t.filter(x=>x.id!==id); localStorage.setItem('downloadTasks', JSON.stringify(t)); renderTasks(); }

// install flow: assemble manifest url and open itms-services://...
function installTask(id){
  const tasks = JSON.parse(localStorage.getItem('downloadTasks') || '[]');
  const t = tasks.find(x=>x.id===id);
  if(!t) return alert('ä»»åŠ¡ä¸å­˜åœ¨');
  // build manifest URL expected by installapp.js
  // installapp expects query params: name, displayVersion, id, bundleId
  // we'll use t.name / t.displayVersion / t.appId / t.bundleId
  const name = encodeURIComponent(t.name || '');
  const displayVersion = encodeURIComponent(t.displayVersion || '');
  const appId = encodeURIComponent(t.appId || t.appId || '');
  const bundleId = encodeURIComponent(t.bundleId || '');
  const manifestUrl = `${INSTALL_HOST}/?name=${name}&displayVersion=${displayVersion}&id=${appId}&bundleId=${bundleId}`;
  // Manifest URL must be accessible by iOS. Now open it via itms-services.
  const itms = 'itms-services://?action=download-manifest&url=' + encodeURIComponent(manifestUrl);
  // Mark status
  t.status = 'installing';
  localStorage.setItem('downloadTasks', JSON.stringify(tasks));
  renderTasks();
  // redirect to itms-services to trigger install
  window.location.href = itms;
}

// ---------- init ----------
navTo('search');
renderTasks();
renderAccounts();

</script>
</body>
</html>