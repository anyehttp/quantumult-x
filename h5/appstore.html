<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Surge IPA Installer</title>
<style>
  :root{--bg:#f5f5f7;--card:#fff;--accent:#007aff;--muted:#666}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;background:var(--bg);color:#111}
  .wrap{padding:14px;padding-bottom:90px}
  .card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
  input,select,button,textarea{width:100%;box-sizing:border-box;font-size:15px;padding:10px;border-radius:8px;border:1px solid #ddd}
  button{background:var(--accent);color:#fff;border:none}
  .tabbar{position:fixed;left:0;right:0;bottom:0;height:62px;display:flex;background:#fff;border-top:1px solid #e6e6e6}
  .tabbar button{flex:1;border:0;background:transparent;font-size:13px;padding:8px}
  .hidden{display:none}
  .title{font-weight:600;margin-bottom:8px}
  .row{display:flex;gap:8px}
  .half{flex:1}
  .result{white-space:pre-wrap;font-size:13px;color:var(--muted);margin-top:8px}
  .app-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;border:1px solid #eee;margin-bottom:8px;background:#fff}
  .app-item img{width:56px;height:56px;border-radius:12px;object-fit:cover}
  .app-info{flex:1}
  .small{font-size:13px;color:#666}
  .btn-row{display:flex;gap:8px}
  .tiny{padding:6px 8px;font-size:13px;border-radius:8px}
  .danger{background:#ff3b30}
  .ok{background:#34c759}
</style>
</head>
<body>
<div class="wrap">

  <!-- SEARCH PAGE -->
  <div id="page-search" class="page">
    <div class="card">
      <div class="title">æœç´¢åº”ç”¨</div>
      <input id="searchInput" placeholder="è¾“å…¥åº”ç”¨åç§°æˆ– Bundle IDï¼ˆä¾‹å¦‚ WeChat / com.tencent.xinï¼‰" />
      <div style="height:10px"></div>

      <div class="row">
        <select id="regionSelect" class="half">
          <option value="US">ç¾å›½ (US)</option>
          <option value="CN" selected>ä¸­å›½ (CN)</option>
          <option value="JP">æ—¥æœ¬ (JP)</option>
          <option value="HK">é¦™æ¸¯ (HK)</option>
          <option value="TW">å°æ¹¾ (TW)</option>
          <option value="GB">è‹±å›½ (GB)</option>
          <option value="DE">å¾·å›½ (DE)</option>
        </select>

        <select id="limitSelect" class="half">
          <option value="5">5 æ¡</option>
          <option value="10" selected>10 æ¡</option>
          <option value="20">20 æ¡</option>
        </select>
      </div>

      <div style="height:8px"></div>
      <select id="deviceSelect">
        <option value="iphone">iPhone</option>
        <option value="ipad">iPad</option>
        <option value="both" selected>åŒæ—¶æœç´¢ iPhone å’Œ iPad</option>
      </select>

      <div style="height:12px"></div>
      <button onclick="doSearch()">å¼€å§‹æœç´¢</button>
      <div id="searchMsg" class="result"></div>
    </div>

    <div id="searchResults"></div>
  </div>

  <!-- TASKS PAGE -->
  <div id="page-tasks" class="page hidden">
    <div class="card">
      <div class="title">ä¸‹è½½ä»»åŠ¡ï¼ˆå‰ç«¯ä»»åŠ¡ç®¡ç†ï¼‰</div>
      <div class="small">è¯´æ˜ï¼šåç«¯è¿”å› IPA ç›´é“¾ï¼Œå‰ç«¯å°†æŠŠä»»åŠ¡ä¿¡æ¯ä¿å­˜åˆ° localStorageã€‚è¦å®‰è£…è¯·ç‚¹å‡»â€œå®‰è£…â€ï¼ˆè°ƒç”¨ xiaobai.app/install?url=...ï¼‰ã€‚</div>
    </div>
    <div id="taskList"></div>
  </div>

  <!-- FILES PAGE -->
  <div id="page-files" class="page hidden">
    <div class="card">
      <div class="title">å·²ç™»è®°æ–‡ä»¶ï¼ˆæœ¬åœ°ï¼‰</div>
      <div class="small">è‹¥ä½ å·²åœ¨è®¾å¤‡ä¸Šä¿å­˜ .ipaï¼Œå¯æ‰‹åŠ¨æ·»åŠ è®°å½•ä»¥ä¾¿å®‰è£…ã€‚</div>
      <div style="height:8px"></div>
      <input id="fileLabel" placeholder="æ–‡ä»¶æ˜¾ç¤ºåç§°ï¼Œä¾‹å¦‚ å¾®ä¿¡ 8.0.0" />
      <input id="fileUrl" placeholder="IPA ä¸‹è½½é“¾æ¥ æˆ– æœ¬åœ°å¯è®¿é—®é“¾æ¥" style="margin-top:8px"/>
      <div style="height:8px"></div>
      <div class="row">
        <button onclick="addFile()" class="half">æ·»åŠ æ–‡ä»¶</button>
        <button onclick="clearFiles()" class="half tiny danger">æ¸…ç©ºåˆ—è¡¨</button>
      </div>
    </div>
    <div id="fileList"></div>
  </div>

  <!-- SETTINGS & ACCOUNTS PAGE -->
  <div id="page-settings" class="page hidden">
    <div class="card">
      <div class="title">åç«¯åœ°å€ï¼ˆé»˜è®¤å·²é…ç½®ï¼‰</div>
      <input id="apiEndpoint" placeholder="Apple API åœ°å€ (ä¾‹å¦‚ https://apple-api.com)" />
      <input id="installEndpoint" placeholder="å®‰è£…æ¥å£ (ä¾‹å¦‚ https://xiaobai.app)" style="margin-top:8px"/>
      <div style="height:8px"></div>
      <div class="row">
        <button onclick="saveEndpoints()" class="half">ä¿å­˜</button>
        <button onclick="resetEndpoints()" class="half tiny">æ¢å¤é»˜è®¤</button>
      </div>
    </div>

    <div class="card">
      <div class="title">å¤šè´¦å·ç™»å½•ç®¡ç†</div>

      <div id="accountForm">
        <input id="acctName" placeholder="æ˜µç§°ï¼ˆä¾‹å¦‚ main / alt1ï¼‰" />
        <input id="acctEmail" placeholder="Apple IDï¼ˆé‚®ç®±ï¼‰" style="margin-top:8px" />
        <input id="acctPassword" placeholder="å¯†ç ï¼ˆåªç”¨äºç™»å½•ï¼›å‰ç«¯æœ¬åœ°ä¿å­˜ï¼‰" style="margin-top:8px" />
        <div style="height:8px"></div>
        <div class="row">
          <button onclick="acctLogin()" class="half">ç™»å½•å¹¶ä¿å­˜</button>
          <button onclick="acctAddLocal()" class="half tiny">ä»…æœ¬åœ°ä¿å­˜</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div id="accountsList"></div>
    </div>
  </div>

</div>

<!-- bottom tab -->
<div class="tabbar">
  <button onclick="navTo('search')">ğŸ” æœç´¢</button>
  <button onclick="navTo('tasks')">â¬‡ï¸ ä»»åŠ¡</button>
  <button onclick="navTo('files')">ğŸ“ æ–‡ä»¶</button>
  <button onclick="navTo('settings')">âš™ï¸ è®¾ç½®</button>
</div>

<script>
/*
  appstore.html
  - çº¯åŸç”Ÿ JS
  - ä¸¥æ ¼æ˜ å°„ä½ æä¾›çš„åç«¯æ¥å£ï¼ˆè§è¯´æ˜ï¼‰
  - å¤šè´¦å·ï¼šlocalStorage ç®¡ç†ï¼›ç™»å½•ä¼šè°ƒç”¨åç«¯ /auth/loginï¼ˆåç«¯ä¼šç¼“å­˜ç™»å½•å“åº”ï¼‰
*/

// ---------- é»˜è®¤åç«¯åœ°å€ï¼ˆå¯åœ¨è®¾ç½®é¡µä¿®æ”¹ï¼‰ ----------
const DEFAULT_API = 'https://apple-api.com';      // ä½ åç«¯æœåŠ¡
const DEFAULT_INSTALL = 'https://xiaobai.app';    // å®‰è£…è„šæœ¬åœ°å€

// load settings
const settings = {
  api: localStorage.getItem('apiEndpoint') || DEFAULT_API,
  install: localStorage.getItem('installEndpoint') || DEFAULT_INSTALL
};

// helper
function $(id){return document.getElementById(id)}
function navTo(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  $('page-'+name).classList.remove('hidden');
  if(name==='tasks') renderTasks();
  if(name==='files') renderFiles();
  if(name==='settings') renderAccounts();
}

// ---------- SEARCH ----------
async function doSearch(){
  const q = $('searchInput').value.trim();
  if(!q){ $('searchMsg').innerText = 'è¯·è¾“å…¥æœç´¢å…³é”®è¯æˆ– Bundle ID'; return; }
  const region = $('regionSelect').value;
  const limit = $('limitSelect').value;
  const device = $('deviceSelect').value;

  $('searchMsg').innerText = 'æ­£åœ¨æœç´¢...';
  try{
    // ä½¿ç”¨ä½ åç«¯çº¦å®šçš„æ¥å£ï¼š GET /search?keyword=xx&country=US&limit=10&device=iphone
    const url = `${settings.api}/search?keyword=${encodeURIComponent(q)}&country=${encodeURIComponent(region)}&limit=${limit}&device=${encodeURIComponent(device)}`;
    const r = await fetch(url);
    const json = await r.json();
    if(!json) throw new Error('æ— å“åº”');
    renderSearchResults(json.data || json);
    $('searchMsg').innerText = json.success === false ? JSON.stringify(json.error||json) : 'æœç´¢å®Œæˆ';
  }catch(e){
    $('searchMsg').innerText = 'æœç´¢å¤±è´¥ï¼š'+e.message;
  }
}

function renderSearchResults(list){
  const wrap = $('searchResults'); wrap.innerHTML='';
  if(!list || !list.length){ wrap.innerHTML='<div class="card small">æœªæ‰¾åˆ°ç»“æœ</div>'; return;}
  list.forEach(app=>{
    const div = document.createElement('div'); div.className='card app-item';
    const icon = document.createElement('img'); icon.src = app.artworkUrl100 || app.icon || '';
    const info = document.createElement('div'); info.className='app-info';
    const name = document.createElement('div'); name.innerHTML = `<strong>${app.trackName || app.name || app.title || app.bundleId}</strong>`;
    const sub = document.createElement('div'); sub.className='small'; sub.innerText = `Bundleï¼š${app.bundleId || app.bundleId || ''}  ç‰ˆæœ¬ï¼š${app.version || app.displayVersion || ''}`;
    const btnRow = document.createElement('div'); btnRow.className='btn-row';

    const dlBtn = document.createElement('button'); dlBtn.className='tiny'; dlBtn.innerText='è·å– IPA';
    dlBtn.onclick = ()=>startDownloadTask(app);

    const verBtn = document.createElement('button'); verBtn.className='tiny'; verBtn.innerText='ç‰ˆæœ¬';
    verBtn.onclick = ()=>showVersion(app);

    btnRow.appendChild(dlBtn); btnRow.appendChild(verBtn);

    info.appendChild(name); info.appendChild(sub); info.appendChild(btnRow);
    div.appendChild(icon); div.appendChild(info);
    wrap.appendChild(div);
  });
}

// ---------- VERSION (simple modal-like) ----------
async function showVersion(app){
  const bundle = app.bundleId || app.bundle || app.trackId;
  const country = $('regionSelect').value || 'CN';
  const url = `${settings.api}/version?bundleId=${encodeURIComponent(bundle)}&country=${encodeURIComponent(country)}`;
  try{
    const r = await fetch(url); const json = await r.json();
    alert('ç‰ˆæœ¬ç»“æœï¼š\n' + JSON.stringify(json, null, 2));
  }catch(e){
    alert('ç‰ˆæœ¬æŸ¥è¯¢å¤±è´¥ï¼š' + e.message);
  }
}

// ---------- DOWNLOAD TASKS (frontend managed) ----------
function loadTasks(){ return JSON.parse(localStorage.getItem('downloadTasks')||'[]'); }
function saveTasks(t){ localStorage.setItem('downloadTasks', JSON.stringify(t)); }

async function startDownloadTask(app){
  // app may have trackId or bundleId
  const trackId = app.trackId || app.trackId || '';
  const bundleId = app.bundleId || app.bundleId || app.bundle || '';
  const version = app.version || app.displayVersion || '';

  const country = $('regionSelect').value || 'CN';
  const q = `${settings.api}/store/download?${trackId ? 'trackId='+encodeURIComponent(trackId) : ''}${bundleId ? '&bundleId='+encodeURIComponent(bundleId) : ''}${version ? '&version='+encodeURIComponent(version) : ''}&country=${encodeURIComponent(country)}`;

  try{
    const r = await fetch(q);
    const json = await r.json();
    if(!(json && (json.data && json.data.url || json.url))) throw new Error('åç«¯æœªè¿”å› IPA é“¾æ¥');
    const ipaUrl = (json.data && json.data.url) || json.url;

    // create front-end task entry
    const tasks = loadTasks();
    const id = 't_'+Date.now();
    const t = { id, name: app.trackName || app.name || bundleId, bundleId, version, trackId, ipaUrl, status:'ready', createdAt: Date.now() };
    tasks.unshift(t); saveTasks(tasks);
    renderTasks();
    alert('å·²åˆ›å»ºä»»åŠ¡ï¼Œå¯åœ¨â€œä»»åŠ¡â€é¡µæŸ¥çœ‹å¹¶å®‰è£…ã€‚');
  }catch(e){
    alert('è·å– IPA é“¾æ¥å¤±è´¥ï¼š' + e.message);
  }
}

function renderTasks(){
  const wrap = $('taskList'); wrap.innerHTML='';
  const tasks = loadTasks();
  if(!tasks.length) { wrap.innerHTML='<div class="card small">å½“å‰æ²¡æœ‰ä¸‹è½½ä»»åŠ¡</div>'; return;}
  tasks.forEach(t=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${t.name}</strong><div class="small">Bundle: ${t.bundleId || '-'}  ç‰ˆæœ¬: ${t.version || '-'}</div></div>
      <div>
        <button class="tiny" onclick="openIpa('${encodeURIComponent(t.ipaUrl)}')">æ‰“å¼€é“¾æ¥</button>
        <button class="tiny ok" onclick="installFromTask('${t.id}')">å®‰è£…</button>
        <button class="tiny danger" onclick="removeTask('${t.id}')">åˆ é™¤</button>
      </div>
    </div>
    <div class="small" style="margin-top:8px">çŠ¶æ€ï¼š${t.status}  Â·  åˆ›å»ºäºï¼š${new Date(t.createdAt).toLocaleString()}</div>
    <div class="result" id="task_${t.id}"></div>`;
    wrap.appendChild(div);
  });
}

function openIpa(ipaEnc){
  const ipa = decodeURIComponent(ipaEnc);
  // åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ ipa é“¾æ¥
  window.open(ipa, '_blank');
}

function removeTask(id){
  let tasks = loadTasks(); tasks = tasks.filter(t=>t.id!==id); saveTasks(tasks); renderTasks();
}

// install via xiaobai.app
async function installFromTask(id){
  const tasks = loadTasks(); const t = tasks.find(x=>x.id===id);
  if(!t){ alert('ä»»åŠ¡ä¸å­˜åœ¨'); return; }
  const ipa = t.ipaUrl;
  if(!ipa){ alert('æ—  ipa é“¾æ¥'); return; }
  if(!confirm(`ç¡®å®šè°ƒç”¨å®‰è£…æ¥å£å®‰è£…ï¼š\n${ipa}`)) return;

  try{
    const url = `${settings.install}/install?url=${encodeURIComponent(ipa)}`;
    const r = await fetch(url);
    const json = await r.json();
    t.status = 'installed';
    saveTasks(tasks);
    renderTasks();
    alert('å®‰è£…æ¥å£è¿”å›ï¼š\n' + JSON.stringify(json, null, 2));
  }catch(e){
    alert('å®‰è£…è°ƒç”¨å¤±è´¥ï¼š'+e.message);
  }
}

// ---------- FILES (local "registered" ipa) ----------
function loadFiles(){ return JSON.parse(localStorage.getItem('localFiles')||'[]'); }
function saveFiles(f){ localStorage.setItem('localFiles', JSON.stringify(f)); }

function renderFiles(){
  const wrap = $('fileList'); wrap.innerHTML='';
  const files = loadFiles();
  if(!files.length){ wrap.innerHTML='<div class="card small">æš‚æ— æ–‡ä»¶</div>'; return; }
  files.forEach(f=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${f.label}</strong><div class="small">${f.url}</div></div>
      <div>
        <button class="tiny" onclick="openIpa('${encodeURIComponent(f.url)}')">æ‰“å¼€</button>
        <button class="tiny ok" onclick="installFile('${encodeURIComponent(f.url)}')">å®‰è£…</button>
        <button class="tiny danger" onclick="deleteFile('${f.id}')">åˆ é™¤</button>
      </div>
    </div>`;
    wrap.appendChild(d);
  });
}

function addFile(){
  const label = $('fileLabel').value.trim(); const url = $('fileUrl').value.trim();
  if(!label || !url){ alert('è¯·å¡«å†™åç§°ä¸é“¾æ¥'); return; }
  const files = loadFiles(); files.unshift({ id:'f_'+Date.now(), label, url }); saveFiles(files); $('fileLabel').value=''; $('fileUrl').value=''; renderFiles();
}

function deleteFile(id){ let files = loadFiles(); files = files.filter(f=>f.id!==id); saveFiles(files); renderFiles(); }
function clearFiles(){ if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ–‡ä»¶è®°å½•å—ï¼Ÿ')) return; localStorage.removeItem('localFiles'); renderFiles(); }
async function installFile(urlEnc){ const url = decodeURIComponent(urlEnc); if(!confirm('è°ƒç”¨å®‰è£…æ¥å£å®‰è£…\n'+url)) return; try{ const r = await fetch(`${settings.install}/install?url=${encodeURIComponent(url)}`); const j = await r.json(); alert('å®‰è£…æ¥å£è¿”å›ï¼š\n'+JSON.stringify(j,null,2)); }catch(e){ alert('å®‰è£…å¤±è´¥ï¼š'+e.message); } }

// ---------- SETTINGS & ACCOUNTS ----------
function saveEndpoints(){
  settings.api = $('apiEndpoint').value.trim() || DEFAULT_API;
  settings.install = $('installEndpoint').value.trim() || DEFAULT_INSTALL;
  localStorage.setItem('apiEndpoint', settings.api);
  localStorage.setItem('installEndpoint', settings.install);
  alert('ä¿å­˜æˆåŠŸ');
}

function resetEndpoints(){
  localStorage.removeItem('apiEndpoint'); localStorage.removeItem('installEndpoint');
  settings.api = DEFAULT_API; settings.install = DEFAULT_INSTALL;
  $('apiEndpoint').value = settings.api; $('installEndpoint').value = settings.install;
  alert('å·²æ¢å¤é»˜è®¤å¹¶ä¿å­˜');
}

// account storage (local)
function loadAccounts(){ return JSON.parse(localStorage.getItem('apple_accounts') || '{"current":null,"list":{}}'); }
function saveAccounts(obj){ localStorage.setItem('apple_accounts', JSON.stringify(obj)); }

function renderAccounts(){
  $('apiEndpoint').value = settings.api; $('installEndpoint').value = settings.install;
  const box = $('accountsList'); box.innerHTML = '';
  const acc = loadAccounts();
  const keys = Object.keys(acc.list || {});
  if(!keys.length){ box.innerHTML = '<div class="small">æš‚æ— å·²ä¿å­˜è´¦å·</div>'; return; }
  keys.forEach(k=>{
    const a = acc.list[k];
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${k}</strong><div class="small">${a.appleId || a.email || ''}</div></div>
      <div>
        <button class="tiny" onclick="useAccount('${k}')">åˆ‡æ¢</button>
        <button class="tiny" onclick="deleteAccount('${k}')">åˆ é™¤</button>
      </div>
    </div>`;
    box.appendChild(div);
  });
}

async function acctLogin(){
  // ç™»å½•å¹¶ä¿å­˜ï¼ˆä¼šè°ƒç”¨åç«¯ /auth/loginï¼‰
  const name = $('acctName').value.trim(); const email = $('acctEmail').value.trim(); const pwd = $('acctPassword').value.trim();
  if(!name || !email || !pwd){ alert('è¯·å¡«å†™æ˜µç§°ã€Apple ID ä¸å¯†ç '); return; }

  // è°ƒç”¨åç«¯ç™»å½•æ¥å£ï¼ˆPOST /auth/loginï¼‰
  try{
    const r = await fetch(`${settings.api}/auth/login`, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ appleId: email, password: pwd })
    });
    const j = await r.json();
    if(!j || j.success === false){ alert('ç™»å½•å¤±è´¥ï¼š' + JSON.stringify(j.error || j)); return; }
    // ç™»å½•æˆåŠŸ - å°†è´¦å·åŠ å…¥æœ¬åœ°åˆ—è¡¨å¹¶è®¾ç½®ä¸ºå½“å‰
    const accounts = loadAccounts();
    accounts.list[name] = { appleId: email, meta: j.data?.loginData || j.data || j };
    accounts.current = name;
    saveAccounts(accounts);
    $('acctName').value=''; $('acctEmail').value=''; $('acctPassword').value='';
    renderAccounts();
    alert('ç™»å½•å¹¶ä¿å­˜æˆåŠŸï¼ˆå·²è®¾ç½®ä¸ºå½“å‰è´¦å·ï¼‰ã€‚\nåç«¯å·²ç¼“å­˜ä¼šè¯ï¼ˆè‹¥åç«¯å®ç°ç¼“å­˜åˆ™ä¼šç”Ÿæ•ˆï¼‰ã€‚');
  }catch(e){
    alert('ç™»å½•è¯·æ±‚å¤±è´¥ï¼š'+e.message);
  }
}

function acctAddLocal(){
  const name = $('acctName').value.trim(); const email = $('acctEmail').value.trim(); const pwd = $('acctPassword').value.trim();
  if(!name || !email){ alert('è¯·è¾“å…¥æ˜µç§°å’Œ Apple ID'); return; }
  const accounts = loadAccounts();
  accounts.list[name] = { appleId: email, note: 'local-only' };
  accounts.current = name;
  saveAccounts(accounts); renderAccounts();
  $('acctName').value=''; $('acctEmail').value=''; $('acctPassword').value='';
  alert('å·²ä¿å­˜è‡³æœ¬åœ°ï¼ˆæœªè°ƒç”¨åç«¯ï¼‰ã€‚');
}

function useAccount(name){
  const accounts = loadAccounts();
  if(!accounts.list[name]) return alert('è´¦å·ä¸å­˜åœ¨');
  accounts.current = name;
  saveAccounts(accounts);
  // å¦‚æœè¯¥è´¦å·åŒ…å« metaï¼ˆåç«¯ç™»å½•å“åº”ï¼‰ï¼Œå°è¯•é€šçŸ¥åç«¯åˆ‡æ¢ä¼šè¯ï¼ˆåç«¯ AuthService.login ä¼šæ£€æŸ¥ appleIdï¼‰
  const info = accounts.list[name];
  if(info.meta && info.meta.accountInfo && info.meta.accountInfo.appleId){
    alert('å·²è®¾ç½®ä¸ºå½“å‰è´¦å·ï¼ˆæœ¬åœ°ï¼‰ã€‚å‰ç«¯å°†è°ƒç”¨åç«¯æ— å‚è¯·æ±‚ä»¥åŠ è½½å½“å‰ç¼“å­˜ä¼šè¯ã€‚');
    // è§¦å‘åç«¯æ— å‚ login å»è¯»å–ç¼“å­˜ï¼ˆå¦‚æœåç«¯ç¼“å­˜äº†è¯¥è´¦å·ï¼‰
    fetch(`${settings.api}/auth/refresh`, { method:'POST' })
      .then(r=>r.json()).then(j=>{ console.log('refresh', j); alert('å·²è¯·æ±‚åç«¯åˆ·æ–°ç™»å½•ä¿¡æ¯ï¼ˆè‹¥åç«¯ç¼“å­˜å­˜åœ¨åˆ™å·²åˆ‡æ¢ï¼‰ã€‚'); })
      .catch(e=>alert('è¯·æ±‚åç«¯åˆ·æ–°ç™»å½•å¤±è´¥ï¼š'+e.message));
  }else{
    alert('å·²åˆ‡æ¢æœ¬åœ°è´¦å·ï¼Œä½†è¯¥é¡¹æ²¡æœ‰åç«¯ç™»å½•ä¿¡æ¯ï¼ˆéœ€å…ˆé€šè¿‡â€œç™»å½•å¹¶ä¿å­˜â€æŒ‰é’®è¿›è¡Œç™»å½•ï¼‰ã€‚');
  }
  renderAccounts();
}

function deleteAccount(name){
  if(!confirm('åˆ é™¤è´¦å·ï¼š'+name+'ï¼Ÿ')) return;
  const accounts = loadAccounts();
  delete accounts.list[name];
  if(accounts.current===name) accounts.current = null;
  saveAccounts(accounts);
  renderAccounts();
}

/* ---------- init ---------- */
navTo('search');
renderFiles();
renderTasks();
renderAccounts();

</script>
</body>
</html>